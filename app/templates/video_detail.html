{% extends 'layout.html' %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/video.css') }}">
{% endblock %}

{% block content %}
<div class="video-header">
  <h2 class="video-title">{{ video.title }}</h2>
  {% if current_user.is_authenticated and current_user.is_admin %}
  <div class="admin-actions">
    <button onclick="showShareDialog()" class="share-btn">ğŸ”— ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
    <a href="{{ url_for('video.list_shares', vid=video.id) }}" class="manage-btn">ğŸ“‹ ç®¡ç†åˆ†äº«</a>
    <a href="{{ url_for('video.edit', vid=video.id) }}" class="edit-btn">âœï¸ ç¼–è¾‘</a>
  </div>
  {% endif %}
</div>

{% if not video.is_public %}
<div class="private-badge">
  <span>ğŸ”’</span>
  <span>ç§æœ‰è§†é¢‘</span>
</div>
{% endif %}

<div class="video-container">
  <video 
    id="video-player" 
    controls 
    preload="auto" 
    playsinline
    webkit-playsinline
    x5-playsinline
    crossorigin="anonymous">
    {% if is_shared and share_token %}
    <source src="{{ url_for('video.stream', vid=video.id, token=share_token) }}" type="video/mp4">
    {% else %}
    <source src="{{ url_for('video.stream', vid=video.id) }}" type="video/mp4">
    {% endif %}
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
  </video>
</div>

<div class="speed-controls">
  <span class="speed-label">æ’­æ”¾é€Ÿåº¦</span>
  <div class="speed-buttons">
    <button class="speed-btn" onclick="setSpeed(0.5)" data-speed="0.5">0.5x</button>
    <button class="speed-btn" onclick="setSpeed(0.75)" data-speed="0.75">0.75x</button>
    <button class="speed-btn active" onclick="setSpeed(1)" data-speed="1">1x</button>
    <button class="speed-btn" onclick="setSpeed(1.25)" data-speed="1.25">1.25x</button>
    <button class="speed-btn" onclick="setSpeed(1.5)" data-speed="1.5">1.5x</button>
    <button class="speed-btn" onclick="setSpeed(2)" data-speed="2">2x</button>
  </div>
</div>

<div class="video-info">
  ğŸ’¡ æç¤ºï¼šè§†é¢‘ä¼šè‡ªåŠ¨ç¼“å­˜ï¼Œç½‘ç»œå·®æ—¶å¯æš‚åœç­‰å¾…ç¼“å†²
</div>

<script>
const video = document.getElementById('video-player');
const speedButtons = document.querySelectorAll('.speed-btn');

function setSpeed(rate) {
  video.playbackRate = rate;
  
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  speedButtons.forEach(btn => {
    if (parseFloat(btn.dataset.speed) === rate) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  // ä¿å­˜ç”¨æˆ·åå¥½
  localStorage.setItem('videoPlaybackRate', rate);
}

// æ¢å¤ä¸Šæ¬¡çš„æ’­æ”¾é€Ÿåº¦
window.addEventListener('load', function() {
  const savedRate = localStorage.getItem('videoPlaybackRate');
  if (savedRate) {
    setSpeed(parseFloat(savedRate));
  }
});

// è®°ä½æ’­æ”¾ä½ç½®
const videoKey = 'video_{{ video.id }}_position';
video.addEventListener('timeupdate', function() {
  if (video.currentTime > 5) { // è¶…è¿‡5ç§’æ‰ä¿å­˜
    localStorage.setItem(videoKey, video.currentTime);
  }
});

// æ¢å¤æ’­æ”¾ä½ç½®
window.addEventListener('load', function() {
  const savedPosition = localStorage.getItem(videoKey);
  if (savedPosition && savedPosition > 0) {
    video.currentTime = parseFloat(savedPosition);
  }
});

// æ’­æ”¾å®Œæˆåæ¸…é™¤ä½ç½®
video.addEventListener('ended', function() {
  localStorage.removeItem(videoKey);
});

// é˜²æ­¢åŒå‡»ç¼©æ”¾ï¼ˆiOSï¼‰
let lastTouchEnd = 0;
document.addEventListener('touchend', function(event) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault();
  }
  lastTouchEnd = now;
}, false);

{% if current_user.is_authenticated and current_user.is_admin %}
// åˆ†äº«å¯¹è¯æ¡†
function showShareDialog() {
  const dialog = document.createElement('div');
  dialog.className = 'share-dialog-overlay';
  dialog.innerHTML = `
    <div class="share-dialog">
      <div class="share-dialog-header">
        <h3>ç”Ÿæˆåˆ†äº«é“¾æ¥</h3>
        <button onclick="this.closest('.share-dialog-overlay').remove()" class="close-btn">Ã—</button>
      </div>
      <div class="share-dialog-body">
        <div class="form-group">
          <label>æœ‰æ•ˆæœŸ</label>
          <select id="expiresHours" class="form-control">
            <option value="">æ°¸ä¹…æœ‰æ•ˆ</option>
            <option value="1">1å°æ—¶</option>
            <option value="24" selected>24å°æ—¶</option>
            <option value="168">7å¤©</option>
            <option value="720">30å¤©</option>
          </select>
        </div>
        <div class="form-group">
          <label>è®¿é—®æ¬¡æ•°é™åˆ¶</label>
          <select id="maxViews" class="form-control">
            <option value="">æ— é™åˆ¶</option>
            <option value="10">10æ¬¡</option>
            <option value="50">50æ¬¡</option>
            <option value="100">100æ¬¡</option>
          </select>
        </div>
        <button onclick="generateShare()" class="btn-primary">ç”Ÿæˆé“¾æ¥</button>
      </div>
      <div id="shareResult" class="share-result" style="display:none;">
        <div class="success-message">âœ… åˆ†äº«é“¾æ¥å·²ç”Ÿæˆ</div>
        <div class="share-url-container">
          <input type="text" id="shareUrl" readonly class="share-url-input">
          <button onclick="copyShareUrl()" class="btn-copy">å¤åˆ¶</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(dialog);
}

function generateShare() {
  const expiresHours = document.getElementById('expiresHours').value;
  const maxViews = document.getElementById('maxViews').value;
  
  fetch('{{ url_for("video.create_share", vid=video.id) }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      expires_hours: expiresHours || null,
      max_views: maxViews || null
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      document.getElementById('shareUrl').value = data.share_url;
      document.getElementById('shareResult').style.display = 'block';
    } else {
      alert('ç”Ÿæˆå¤±è´¥: ' + data.error);
    }
  })
  .catch(err => {
    alert('ç”Ÿæˆå¤±è´¥: ' + err.message);
  });
}

function copyShareUrl() {
  const input = document.getElementById('shareUrl');
  input.select();
  document.execCommand('copy');
  
  const btn = event.target;
  const originalText = btn.textContent;
  btn.textContent = 'å·²å¤åˆ¶!';
  setTimeout(() => {
    btn.textContent = originalText;
  }, 2000);
}
{% endif %}
</script>

<style>
.admin-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.share-btn, .manage-btn {
  padding: 8px 16px;
  background: #2196f3;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-decoration: none;
  display: inline-block;
  font-size: 14px;
}

.share-btn:hover, .manage-btn:hover {
  background: #1976d2;
}

.manage-btn {
  background: #4caf50;
}

.manage-btn:hover {
  background: #388e3c;
}

.share-dialog-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.share-dialog {
  background: white;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
}

.share-dialog-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #eee;
}

.share-dialog-header h3 {
  margin: 0;
  font-size: 18px;
}

.close-btn {
  background: none;
  border: none;
  font-size: 28px;
  cursor: pointer;
  color: #999;
  line-height: 1;
}

.close-btn:hover {
  color: #333;
}

.share-dialog-body {
  padding: 20px;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.btn-primary {
  width: 100%;
  padding: 12px;
  background: #2196f3;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 500;
}

.btn-primary:hover {
  background: #1976d2;
}

.share-result {
  padding: 20px;
  border-top: 1px solid #eee;
}

.success-message {
  color: #4caf50;
  margin-bottom: 16px;
  font-weight: 500;
}

.share-url-container {
  display: flex;
  gap: 10px;
}

.share-url-input {
  flex: 1;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  font-family: monospace;
}

.btn-copy {
  padding: 10px 20px;
  background: #4caf50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
}

.btn-copy:hover {
  background: #388e3c;
}
</style>
{% endblock %}