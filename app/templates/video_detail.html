{% extends 'layout.html' %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/video.css') }}">
{% endblock %}

{% block content %}
<div class="video-header">
  <h2 class="video-title">{{ video.title }}</h2>
  {% if current_user.is_authenticated and current_user.is_admin %}
  <a href="{{ url_for('video.edit', vid=video.id) }}" class="edit-btn">ç¼–è¾‘</a>
  {% endif %}
</div>

{% if not video.is_public %}
<div class="private-badge">
  <span>ğŸ”’</span>
  <span>ç§æœ‰è§†é¢‘</span>
</div>
{% endif %}

<div class="video-container">
  <video 
    id="video-player" 
    controls 
    preload="auto" 
    playsinline
    webkit-playsinline
    x5-playsinline
    crossorigin="anonymous">
    <source src="{{ url_for('video.stream', vid=video.id) }}" type="video/mp4">
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
  </video>
</div>

<div class="speed-controls">
  <span class="speed-label">æ’­æ”¾é€Ÿåº¦</span>
  <div class="speed-buttons">
    <button class="speed-btn" onclick="setSpeed(0.5)" data-speed="0.5">0.5x</button>
    <button class="speed-btn" onclick="setSpeed(0.75)" data-speed="0.75">0.75x</button>
    <button class="speed-btn active" onclick="setSpeed(1)" data-speed="1">1x</button>
    <button class="speed-btn" onclick="setSpeed(1.25)" data-speed="1.25">1.25x</button>
    <button class="speed-btn" onclick="setSpeed(1.5)" data-speed="1.5">1.5x</button>
    <button class="speed-btn" onclick="setSpeed(2)" data-speed="2">2x</button>
  </div>
</div>

<div class="video-info">
  ğŸ’¡ æç¤ºï¼šè§†é¢‘ä¼šè‡ªåŠ¨ç¼“å­˜ï¼Œç½‘ç»œå·®æ—¶å¯æš‚åœç­‰å¾…ç¼“å†²
</div>

<script>
const video = document.getElementById('video-player');
const speedButtons = document.querySelectorAll('.speed-btn');

function setSpeed(rate) {
  video.playbackRate = rate;
  
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  speedButtons.forEach(btn => {
    if (parseFloat(btn.dataset.speed) === rate) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  // ä¿å­˜ç”¨æˆ·åå¥½
  localStorage.setItem('videoPlaybackRate', rate);
}

// æ¢å¤ä¸Šæ¬¡çš„æ’­æ”¾é€Ÿåº¦
window.addEventListener('load', function() {
  const savedRate = localStorage.getItem('videoPlaybackRate');
  if (savedRate) {
    setSpeed(parseFloat(savedRate));
  }
});

// è®°ä½æ’­æ”¾ä½ç½®
const videoKey = 'video_{{ video.id }}_position';
video.addEventListener('timeupdate', function() {
  if (video.currentTime > 5) { // è¶…è¿‡5ç§’æ‰ä¿å­˜
    localStorage.setItem(videoKey, video.currentTime);
  }
});

// æ¢å¤æ’­æ”¾ä½ç½®
window.addEventListener('load', function() {
  const savedPosition = localStorage.getItem(videoKey);
  if (savedPosition && savedPosition > 0) {
    video.currentTime = parseFloat(savedPosition);
  }
});

// æ’­æ”¾å®Œæˆåæ¸…é™¤ä½ç½®
video.addEventListener('ended', function() {
  localStorage.removeItem(videoKey);
});

// é˜²æ­¢åŒå‡»ç¼©æ”¾ï¼ˆiOSï¼‰
let lastTouchEnd = 0;
document.addEventListener('touchend', function(event) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault();
  }
  lastTouchEnd = now;
}, false);
</script>
{% endblock %}